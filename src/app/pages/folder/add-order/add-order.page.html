<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/orders"></ion-back-button>
    </ion-buttons>
    <ion-title>Nuevo Pedido</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-card>
    <ion-card-content>
      <ion-item>
        <div class="custom-select-wrapper" (click)="openCustomerModal()">
          <ion-label position="stacked">Cliente</ion-label>
          <div class="custom-select-value">
            <span *ngIf="!selectedCustomerId" class="placeholder">Seleccione un cliente</span>
            <span *ngIf="selectedCustomerId">{{ getSelectedCustomerName() }}</span>
          </div>
        </div>
        <ion-button *ngIf="selectedCustomerId" (click)="showCustomerDetails()" slot="end" fill="solid">
          <ion-icon name="eye-outline"></ion-icon>
        </ion-button>
      </ion-item>

      <ion-item>
        <ion-select [(ngModel)]="selectedBranchId" label="Sucursal" label-placement="stacked"
          placeholder="Seleccione una sucursal">
          <ion-select-option *ngFor="let branch of branches" [value]="branch.id">{{ branch.businessName
            }}</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-select [(ngModel)]="selectedShipping" label="Envío" label-placement="stacked" placeholder="Seleccione un tipo de envío">
          <ion-select-option value="pickup">Retiro en el local</ion-select-option>
          <ion-select-option value="delivery">Envío a domicilio</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-select [(ngModel)]="selectedPriceList" (ionChange)="onPriceListChange()" label="Lista de Precios" label-placement="stacked">
          <ion-select-option *ngFor="let price of priceLists" [value]="price">{{ price }}</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-textarea [(ngModel)]="observation" label="Observaciones" label-placement="stacked" placeholder="Ingrese sus observaciones"></ion-textarea>
      </ion-item>

      <div class="search-container">
        <ion-searchbar [(ngModel)]="searchQuery" placeholder="Buscar por SKU o nombre"></ion-searchbar>
        <ion-button (click)="searchArticles()">
          <ion-icon name="search-outline"></ion-icon>
          Buscar
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Items: {{ orderItems.length }} | Total: {{ totalAmount | currency
        }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item-sliding #slidingItem *ngFor="let item of orderItems; let i = index">
          <ion-item>
            <ion-label>
              <h2>{{ item.article.name }}</h2>
              <p>SKU: {{ item.article.sku }}</p>
              <p>Precio: {{ item.unitPrice | currency }}</p>
            </ion-label>
            <div class="quantity-controls">
              <ion-input class="quantity-input" color="primary" label-placement="floating" fill="outline" type="number"
                [(ngModel)]="item.quantity" (ionChange)="updateQuantity(i)" min="1" maxlength="6"></ion-input>
              <p class="subtotal">{{ (item.quantity * item.unitPrice) | currency }}</p>
            </div>
          </ion-item>
          <ion-item-options side="end">
            <ion-item-option color="danger" (click)="removeItem(i, slidingItem)">
              <ion-icon slot="icon-only" name="trash"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
        <ion-item *ngIf="orderItems.length === 0">
          <ion-label>No hay artículos en el pedido.</ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <ion-button expand="full" (click)="saveOrder()" [disabled]="!selectedCustomerId || orderItems.length === 0">Guardar
    Pedido</ion-button>

</ion-content>
